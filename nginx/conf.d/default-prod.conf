upstream backend {
    server seobom-backend-prod:8080;
}

# api.seobom.site - HTTP만 (SSL 발급 전)
server {
    listen 80;
    server_name api.seobom.site;

    # Let's Encrypt 인증서 발급용
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    # 임시로 HTTP로 서비스 (SSL 발급 후 HTTPS 리다이렉트로 변경)
    access_log /var/log/nginx/api.access.log;
    error_log  /var/log/nginx/api.error.log;

    # Swagger UI
    location ^~ /swagger-ui/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_redirect off;
    }

    # Swagger OpenAPI Docs
    location /v3/api-docs {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_redirect off;
    }

    location /v3/api-docs/swagger-config {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_redirect off;
    }

    # SSE Stream
    location /api/notifications/stream {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        chunked_transfer_encoding on;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
        add_header Cache-Control no-cache always;
    }

    # API Reverse Proxy
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        proxy_redirect off;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # OAuth2
    location ^~ /oauth2/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-Port 80;
        proxy_redirect off;
    }

    # Login callback
    location ^~ /login {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-Port 80;
        proxy_redirect off;
    }

    # Actuator
    location /actuator/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
        proxy_redirect off;
    }

    location = /favicon.ico {
        return 204;
    }

    location / {
        return 404;
    }
}

# jenkins.seobom.site
server {
    listen 80;
    server_name jenkins.seobom.site;

    location / {
        proxy_pass http://172.17.0.1:9090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}